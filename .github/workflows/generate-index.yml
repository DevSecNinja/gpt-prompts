name: Generate Prompt Index

on:
  push:
    branches: [ main ]
    paths:
      - 'prompts/**/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    name: Generate Prompt Index
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate index
        run: |
          cat > INDEX.md << EOF
          # ðŸ“‘ Prompt Index
          
          > Auto-generated index of all available prompts
          
          Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          EOF
          
          # Function to extract title from markdown
          get_title() {
            grep -m 1 "^# " "$1" | sed 's/^# //'
          }
          
          # Function to extract description
          get_description() {
            sed -n '/^## Description$/,/^##/p' "$1" | sed '1d;$d' | sed 's/^[[:space:]]*//' | head -n 1
          }
          
          # Function to extract category
          get_category() {
            sed -n '/^## Category$/,/^##/p' "$1" | sed '1d;$d' | sed 's/^[[:space:]]*//' | head -n 1
          }
          
          # Process each category
          for category_dir in prompts/*/; do
            if [ -d "$category_dir" ]; then
              category_name=$(basename "$category_dir")
              category_title=$(echo "$category_name" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
              
              # Check if there are any .md files
              if ls "$category_dir"*.md 1> /dev/null 2>&1; then
                echo "" >> INDEX.md
                echo "## ðŸ“‚ ${category_title}" >> INDEX.md
                echo "" >> INDEX.md
                
                # Process each prompt in the category
                for prompt_file in "$category_dir"*.md; do
                  if [ -f "$prompt_file" ]; then
                    title=$(get_title "$prompt_file")
                    description=$(get_description "$prompt_file")
                    relative_path="${prompt_file#./}"
                    
                    echo "### [${title}](/${relative_path})" >> INDEX.md
                    echo "" >> INDEX.md
                    if [ -n "$description" ]; then
                      echo "$description" >> INDEX.md
                      echo "" >> INDEX.md
                    fi
                  fi
                done
              fi
            fi
          done
          
          # Add footer
          cat >> INDEX.md << 'EOF'
          
          ---
          
          *This index is automatically generated from the prompts directory.*
          EOF

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code INDEX.md || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add INDEX.md
          git commit -m "docs: Update prompt index [skip ci]"
          git push
